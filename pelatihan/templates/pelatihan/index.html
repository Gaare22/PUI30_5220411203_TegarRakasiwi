{% load static %}
<!DOCTYPE html>
<html lang="id">
   <head>
      <!-- basic -->
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <!-- mobile metas -->
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="viewport" content="initial-scale=1, maximum-scale=1">
      <!-- site metas -->
      <title>TRLearn</title>
      <meta name="keywords" content="">
      <meta name="description" content="">
      <meta name="author" content="">
      <!-- bootstrap css -->
      <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
      <!-- style css -->
      <link rel="stylesheet" href="{% static 'css/style.css' %}">
      <!-- Responsive-->
      <link rel="stylesheet" href="{% static 'css/responsive.css' %}">
      <!-- fevicon -->
      <link rel="icon" href="{% static 'img/gabel_logo1.png' %}" type="image/gif" />
      <!-- Tweaks for older IEs-->
      <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
      <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]-->

      <style>
        .box {
        background-color: #d9d9d9;
        border-radius: 20px;
        padding: 20px;
        text-align: center;
        }

        .large-box {
        height: 500px;
        }

        .data-table {
        background-color: white;
        border-radius: 10px;
        overflow: auto;
        max-height: 450px;
        }

        .btn-rounded {
        border-radius: 25px;
        padding: 10px 30px;
        }

        .dropdown-box {
        border: 1px solid #000;
        border-radius: 10px;
        padding: 10px 20px;
        background-color: #d9d9d9;
        }

        .select-style {
        border: none;
        background: transparent;
        outline: none;
        font-weight: bold;
        }

        table {
        width: 100%;
        }

        th, td {
        padding: 6px 10px;
        font-size: 14px;
        }

        .ak-box {
        height: 200px;
        }

      .submit:hover {
         background-color: #f0390f;
      }

      input[type="file"] {
         display: none;
      }

      .pagination {
        margin-top: 15px; /* jarak atas tabel */
        margin-bottom: 10px;
      }

      .pagination .page-link {
        border-radius: 8px;
        margin: 0 6px;        /* jarak antar tombol diperbesar */
        padding: 8px 16px;    /* tombol lebih lebar */
        color: black;
      }

      .pagination .page-item.active .page-link {
        background-color: #f0390f;
        border-color: #f0390f;
        color: white;
      }

      .pagination .page-link:hover {
        background-color: #f0390f;   /* merah saat hover */
        color: white;
        border-color: #f0390f;
      }

      #hoverText:hover{
         color: #f0390f;
      }

      /* Pastikan semua tabel hasil data_preview rata tengah */
      #data-content table {
      width: 100%;
      text-align: center;
      }

      /* Header tabel tetap di tengah */
      #data-content th {
      text-align: center !important;
      }

      /* Isi tabel juga di tengah */
      #data-content td {
      text-align: center !important;
      vertical-align: middle;
      }
            
      </style>
   </head>
   <!-- body -->
   <body class="main-layout">
      <!-- header -->
      <div class="header">
         <div class="container-fluid">
            <div class="row d_flex">
               <div class=" col-md-2 col-sm-3 col logo_section">
                  <div class="full">
                     <div class="center-desk">
                        <div class="logo">
                           <a href="/"><img src="{% static 'img/gabel_logo1.png' %}" alt="#" /></a>
                        </div>
                     </div>
                  </div>
               </div>
               
               <div class="col-md-10 col-sm-12">
                  <nav class="navigation navbar navbar-expand-md navbar-dark ">
                     <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExample04"
                        aria-controls="navbarsExample04" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                     </button>
                     <div class="collapse navbar-collapse" id="navbarsExample04">
                        <ul class="navbar-nav mr-auto">
                           <li class="nav-item">
                              <a class="nav-link" href="/homeadmin/">Dashboard</a>
                           </li>
                           <li class="nav-item">
                              <a class="nav-link" href="/info_data/">Data</a>
                           </li>
                           <li class="nav-item">
                              <a class="nav-link" href="/input_data/">Input Data</a>
                           </li>
                           <li class="nav-item active">
                              <a class="nav-link" href="/pelatihan/">Pelatihan</a>
                           </li>
                           <li class="nav-item">
                              <a class="nav-link" href="/pengujian/">Pengujian</a>
                           </li>
                           <li class="nav-item">
                              <a class="nav-link" href="/prediksi_admin/">Prediksi</a>
                           </li>
                        </ul>

                        <!-- Logout otomatis ke kanan -->
                        <ul class="navbar-nav ml-auto">
                           <li class="nav-item">
                              <a class="nav-link" href="/">Logout</a>
                           </li>
                        </ul>
                     </div>
                  </nav>
               </div>

            </div>
         </div>
      </div>

      <br>
      <br>
      <br>
      <hr style="border-top: 2px solid #f0390f; border-bottom: 0;">
      <br>
      <!-- end header inner -->
      <!-- end header -->
      <div class="container-fluid py-4">
        <div class="row">
          <!-- Kolom Kiri -->
          <div class="col-md-8">
            <div id="data-box" class="box large-box data-tampilan">
              <h5 class="mb-4">DATA YANG AKAN DILATIH</h5>
              <div class="data-table mx-auto w-100" style="max-height: 380px; overflow: auto;">
               <div id="data-content">
                  {% if data_preview %}
                     {{ data_preview|safe }}
                  {% else %}
                     Silakan pilih sumber data.
                  {% endif %}
               </div>
               {% if num_pages > 1 %}
                  <nav aria-label="Page navigation">
                  <ul class="pagination justify-content-center">
                     {% if current_page > 1 %}
                        <li class="page-item"><a class="page-link" href="?page=1">First</a></li>
                        <li class="page-item"><a class="page-link" href="?page={{ current_page|add:-1 }}">Previous</a></li>
                     {% else %}
                        <li class="page-item disabled"><span class="page-link">First</span></li>
                        <li class="page-item disabled"><span class="page-link">Previous</span></li>
                     {% endif %}

                     {% for i in num_pages|make_list %}
                        {% if forloop.counter == current_page %}
                        <li class="page-item active"><span class="page-link">{{ forloop.counter }}</span></li>
                        {% else %}
                        <li class="page-item"><a class="page-link" href="?page={{ forloop.counter }}">{{ forloop.counter }}</a></li>
                        {% endif %}
                     {% endfor %}

                     {% if current_page < num_pages %}
                        <li class="page-item"><a class="page-link" href="?page={{ current_page|add:1 }}">Next</a></li>
                        <li class="page-item"><a class="page-link" href="?page={{ num_pages }}">Last</a></li>
                     {% else %}
                        <li class="page-item disabled"><span class="page-link">Next</span></li>
                        <li class="page-item disabled"><span class="page-link">Last</span></li>
                     {% endif %}
                  </ul>
                  </nav>
               {% endif %}
              </div>
            </div>
          </div>
    
          <!-- Kolom Kanan -->
          <div class="col-md-4 d-flex flex-column justify-content-between">
            <form action="" method="post"> {% csrf_token %}
               <div class="mb-3">
               <div class="dropdown-box d-flex justify-content-between align-items-center mb-3">
                  <span>PILIH DATA YANG DIGUNAKAN :</span>
                  <select name="source" id="dataSource" onchange="handleDataSourceChange()" class="select-style" required>
                     <option selected>-- PILIH DATA --</option>
                     <option value="database" {% if selected_source == "database" %}selected{% endif %}>Data Pelatihan</option>
                     <!-- <option value="csv" {% if selected_source == "csv" %}selected{% endif %}>Import CSV</option> -->
                  </select>
               </div>

               <input type="file" id="csv-upload" accept=".csv" style="display: none;">
               </div>
            
              <div class="dropdown-box d-flex justify-content-between align-items-center" style="margin-top: 0px;">
                <span>BANYAK DATA DI LATIH (%) :</span>
                <input type="number" min="1" max="99" step="0.01" class="input-percentage" name="split" style="width: 100px;" value="{{ split_ratio|default:'' }}" required>
              </div>

              <div class="dropdown-box d-flex justify-content-between align-items-center" style="margin-top: 20px; height: 64px;">
                  <div class="inpo_prob">
                     {% if prob_info %}
                        <a href="#" data-toggle="modal" data-target="#probModal" id="hoverText">Informasi Probabilitas</a>
                     {% else %}
                        <p style="margin-top: 16px;">Informasi Probabilitas</p>
                     {% endif %}
                  </div>

                  <div class="selected_features">
                     {% if selected_features %}
                        <a href="#" data-toggle="modal" data-target="#featureModal" id="hoverText">Features Terpilih</a>
                     {% else %}
                        <p style="margin-top: 16px;">Features Terpilih</p>
                     {% endif %}
                  </div>
               </div>
    
               <div class="box ak-box mb-3" style="margin-top: 40px;">
                  <div class="text-center mb-2">
                     <h5>AKURASI PELATIHAN</h5>
                  </div>
                  <div class="d-flex justify-content-center align-items-center" style="height: 100px;">
                     {% if akurasi %}
                        <div class="fs-3 fw-bold" style="font-size: 24px;">{{ akurasi }}%</div>
                     {% endif %}

                     {% if error %}
                        <div style="color: red;">{{ error }}</div>
                     {% endif %}
                  </div>
               </div>               

               <div>
                  <button type="submit" class="btn btn-secondary btn-rounded w-100 submit">LATIH DATA</button>
               </div>
            </form>

            
          </div>
        </div>
      </div>

      

        <!--  footer -->
        <!-- end footer -->
        <!-- Javascript files-->
        <script src="{% static 'js/jquery.min.js' %}"></script>
        <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
        <script src="{% static 'js/jquery-3.0.0.min.js' %}"></script>
        <!-- sidebar -->
        <script src="{% static 'js/custom.js' %}"></script>
        <script>
            AOS.init();

            function handleDataSourceChange() {
               const selected = document.getElementById("dataSource").value;
               const dataContent = document.getElementById("data-content");

               if (selected === "database") {
                  // fetch('/pelatihan/get_data_database/')
                  // .then(response => response.json())
                  // .then(data => {
                  //       if (data.success) {
                  //          displayTable(data.columns, data.rows);
                  //       } else {
                  //          dataContent.innerHTML = "Gagal memuat data.";
                  //       }
                  // });

                  loadPage(1);
               } else if (selected === "csv") {
                  document.getElementById('csv-upload').click();
                  document.getElementById('csv-upload').addEventListener('change', function() {
                  const fileInput = this;
                  const formData = new FormData();
                  formData.append('file', fileInput.files[0]);

                  fetch('/pelatihan/upload_csv/', {
                     method: 'POST',
                     body: formData,
                     headers: {
                           'X-CSRFToken': '{{ csrf_token }}'
                     }
                  })
                  .then(response => response.json())
                  .then(data => {
                     if (data.success) {
                           displayTable(data.columns, data.rows);
                     } else {
                           document.getElementById("data-content").innerHTML = "Gagal memuat CSV: " + data.error;
                     }
                  });
               });
               } else {
                  dataContent.innerHTML = "Silakan pilih data yang digunakan";
               }
            }

            

            // function displayTable(columns, rows) {
            //    let html = "<table border='1'><tr>";
            //    columns.forEach(col => {
            //       html += `<th>${col}</th>`;
            //    });
            //    html += "</tr>";

            //    rows.forEach(row => {
            //       html += "<tr>";
            //       row.forEach(cell => {
            //             html += `<td>${cell}</td>`;
            //       });
            //       html += "</tr>";
            //    });
            //    html += "</table>";

            //    document.getElementById("data-content").innerHTML = html;
            // }

            function displayTable(columns, rows, num_pages = 1, current_page = 1) {
               let html = "<table border='1'><tr>";
               columns.forEach(col => {
                  html += `<th>${col}</th>`;
               });
               html += "</tr>";

               rows.forEach(row => {
                  html += "<tr>";
                  row.forEach(cell => {
                     html += `<td>${cell}</td>`;
                  });
                  html += "</tr>";
               });
               html += "</table>";

               // Tambahkan pagination buttons
               // if (num_pages > 1) {
               //    html += "<div class='pagination mt-3'>";
               //    for (let i = 1; i <= num_pages; i++) {
               //       if (i === current_page) {
               //          html += `<button disabled>${i}</button> `;
               //       } else {
               //          html += `<button onclick="loadPage(${i})">${i}</button> `;
               //       }
               //    }
               //    html += "</div>";
               // }

               if (num_pages > 1) {
                    html += `<nav aria-label="Page navigation">
                                <ul class="pagination justify-content-center">`;

                  //   // Tombol Previous
                  //   if (current_page > 1) {
                  //       html += `<li class="page-item">
                  //                   <a class="page-link" href="javascript:void(0)" onclick="loadPage(${current_page - 1})">Previous</a>
                  //               </li>`;
                  //   } else {
                  //       html += `<li class="page-item disabled">
                  //                   <span class="page-link">Previous</span>
                  //               </li>`;
                  //   }

                    // Tombol "First" dan "Previous"
                     if (current_page > 1) {
                        html += `<li class="page-item">
                                    <a class="page-link" href="javascript:void(0)" onclick="loadPage(1)">First</a>
                                 </li>`;
                        html += `<li class="page-item">
                                    <a class="page-link" href="javascript:void(0)" onclick="loadPage(${current_page - 1})">Previous</a>
                                 </li>`;
                     } else {
                        html += `<li class="page-item disabled"><span class="page-link">First</span></li>`;
                        html += `<li class="page-item disabled"><span class="page-link">Previous</span></li>`;
                     }

                     // Tampilkan hanya 3 halaman di sekitar current_page
                     let startPage = Math.max(1, current_page - 1);
                     let endPage = Math.min(num_pages, current_page + 1);

                     if (startPage > 1) {
                        html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                     }

                     for (let i = startPage; i <= endPage; i++) {
                        if (i === current_page) {
                           html += `<li class="page-item active">
                                       <span class="page-link" style="background-color:#f0390f; border-color:#f0390f;">${i}</span>
                                    </li>`;
                        } else {
                           html += `<li class="page-item">
                                       <a class="page-link" href="javascript:void(0)" onclick="loadPage(${i})">${i}</a>
                                    </li>`;
                        }
                     }

                     if (endPage < num_pages) {
                        html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                     }

                     // Tombol "Next" dan "Last"
                     if (current_page < num_pages) {
                        html += `<li class="page-item">
                                    <a class="page-link" href="javascript:void(0)" onclick="loadPage(${current_page + 1})">Next</a>
                                 </li>`;
                        html += `<li class="page-item">
                                    <a class="page-link" href="javascript:void(0)" onclick="loadPage(${num_pages})">Last</a>
                                 </li>`;
                     } else {
                        html += `<li class="page-item disabled"><span class="page-link">Next</span></li>`;
                        html += `<li class="page-item disabled"><span class="page-link">Last</span></li>`;
                     }


                  //   // Tombol Next
                  //   if (current_page < num_pages) {
                  //       html += `<li class="page-item">
                  //                   <a class="page-link" href="javascript:void(0)" onclick="loadPage(${current_page + 1})">Next</a>
                  //               </li>`;
                  //   } else {
                  //       html += `<li class="page-item disabled">
                  //                   <span class="page-link">Next</span>
                  //               </li>`;
                  //   }

                    html += `</ul></nav>`;
                    }

               document.getElementById("data-content").innerHTML = html;
            }

            function loadPage(page) {
               fetch(`/pelatihan/get_data_database/?page=${page}`)
               .then(response => response.json())
               .then(data => {
                  if (data.success) {
                     displayTable(data.columns, data.rows, data.num_pages, data.current_page);
                  } else {
                     document.getElementById("data-content").innerHTML = "Gagal memuat data.";
                  }
               });
            }

            document.getElementById("dataSource").addEventListener("change", function () {
               document.getElementById("selectedSource").value = this.value;
            });

            document.getElementById("form-pelatihan").addEventListener("submit", function(e) {
               const sourceSelected = document.querySelector('input[name="source"]:checked');
               if (!sourceSelected) {
                  alert("Silakan pilih sumber data terlebih dahulu (CSV atau Database).");
                  e.preventDefault();
               }
            });

            document.querySelector('.submit').addEventListener('click', function (e) {
               e.preventDefault();

               const formData = new FormData();
               formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
               formData.append('source', document.querySelector('#dataSource').value);
               formData.append('split', document.querySelector('input[name="split"]').value);

               fetch('/pelatihan/', {
                  method: 'POST',
                  body: formData
               })
               .then(res => res.text())
               .then(html => {
                  // Update hanya bagian kanan (akurasi dan info probabilitas)
                  const parser = new DOMParser();
                  const doc = parser.parseFromString(html, 'text/html');

                  // Ambil bagian akurasi dan probabilitas dari hasil response
                  const akurasiBox = doc.querySelector('.ak-box').innerHTML;
                  document.querySelector('.ak-box').innerHTML = akurasiBox;

                  const probBox = doc.querySelector('[data-target="#probModal"]')?.outerHTML;
                  if (probBox) {
                        document.querySelector('.dropdown-box:last-child').innerHTML = probBox;
                  }

                  alert("Pelatihan selesai! Akurasi diperbarui tanpa reload halaman.");
               });
            });
        </script>

         <!-- Modal Informasi Probabilitas -->
        <div class="modal fade" id="probModal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-xl" role="document">
               <div class="modal-content">
                  <div class="modal-header">
                  <h5 class="modal-title">Perhitungan Probabilitas Naive Bayes</h5>
                  <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                  </div>
                  <div class="modal-body">

                  {% if prob_info %}
                     {% load custom_tags %}
                     <h6>Prior Probabilities</h6>
                     <ul>
                     {% for stat in prob_info.kelas_stats %}
                        <li>{{ stat.kelas }} : {{ stat.prior|floatformat:4 }} (jumlah: {{ stat.jumlah }})</li>
                     {% endfor %}
                     </ul>

                     <hr>

                     <h6>Likelihood Jenis Kelamin</h6>
                     <table class="table table-bordered table-sm">
                     <thead>
                        <tr>
                           <th>Jenis Kelamin</th>
                           {% for stat in prob_info.kelas_stats %}
                           <th>{{ stat.kelas }}</th>
                           {% endfor %}
                        </tr>
                     </thead>
                     <tbody>
                        {% for row in prob_info.jenis_kelamin %}
                           <tr>
                           <td>{{ row.Pilihan }}</td>
                           {% for stat in prob_info.kelas_stats %}
                              <td>{{ row|get_item:stat.kelas|floatformat:6 }}</td>
                           {% endfor %}
                           </tr>
                        {% endfor %}
                     </tbody>
                     </table>

                     <h6>Likelihood Jurusan</h6>
                     <table class="table table-bordered table-sm">
                     <thead>
                        <tr>
                           <th>Jurusan</th>
                           {% for stat in prob_info.kelas_stats %}
                           <th>{{ stat.kelas }}</th>
                           {% endfor %}
                        </tr>
                     </thead>
                     <tbody>
                        {% for row in prob_info.jurusan %}
                           <tr>
                           <td>{{ row.Pilihan }}</td>
                           {% for stat in prob_info.kelas_stats %}
                              <td>{{ row|get_item:stat.kelas|floatformat:6 }}</td>
                           {% endfor %}
                           </tr>
                        {% endfor %}
                     </tbody>
                     </table>

                     <h6>Likelihood Pertanyaan (P1â€“P15)</h6>
                     <table class="table table-bordered table-sm">
                        <thead>
                           <tr>
                              <th>Pertanyaan</th>
                              <th>Pilihan</th>
                              {% for stat in prob_info.kelas_stats %}
                              <th>{{ stat.kelas }}</th>
                              {% endfor %}
                           </tr>
                        </thead>
                        <tbody>
                           {% for row in prob_info.pertanyaan %}
                              <tr>
                              {% if forloop.counter0|divisibleby:5 %}
                                 <td rowspan="5" style="vertical-align: middle; text-align: center;">{{ row.Pertanyaan }}</td>
                              {% endif %}
                              <td style="vertical-align: middle; text-align: center;">{{ row.Pilihan }}</td>
                              {% for stat in prob_info.kelas_stats %}
                                 <td>{{ row|get_item:stat.kelas|floatformat:6 }}</td>
                              {% endfor %}
                              </tr>
                           {% endfor %}
                        </tbody>
                     </table>

                  {% else %}
                     <p>Belum ada informasi probabilitas, silakan latih data dulu.</p>
                  {% endif %}

                  </div>
               </div>
            </div>
         </div>

         <!-- Modal Fitur Terpilih -->
         <div class="modal fade" id="featureModal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-md" role="document">
               <div class="modal-content">
                  <div class="modal-header">
                     <h5 class="modal-title">Fitur Terpilih (Wrapper Selection)</h5>
                     <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                  </div>
                  <div class="modal-body">
                     {% if selected_features %}
                        <ul style="list-style-type: square; padding-left: 25px;">
                           {% for feature in selected_features %}
                              <li>{{ feature }}</li>
                           {% endfor %}
                        </ul>
                     {% else %}
                        <p>Belum ada fitur yang terpilih. Silakan lakukan pelatihan data terlebih dahulu.</p>
                     {% endif %}
                  </div>
               </div>
            </div>
         </div>


    </body>
</html>